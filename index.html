/* 1. CONTADOR DE VISITAS REAL (API) */
async function updateCounter() {
    try {
        // Nota: Si la API de countapi no responde, el catch pondrá un número aleatorio estético
        const response = await fetch('https://api.countapi.xyz/hit/ahyron-web-oficial/visits');
        const data = await response.json();
        document.getElementById('count').innerText = data.value;
    } catch (error) {
        document.getElementById('count').innerText = Math.floor(Math.random() * 500) + 100;
    }
}
updateCounter();

/* 2. CURSOR DE BRUMA (TRAIL) */
const dots = [];
const mousePos = { x: 0, y: 0 };
for (let i = 0; i < 15; i++) {
    const d = document.createElement("div");
    d.className = "trail";
    document.body.appendChild(d);
    dots.push(d);
}
window.addEventListener("mousemove", e => { mousePos.x = e.clientX; mousePos.y = e.clientY; });

function updateTrail() {
    let x = mousePos.x;
    let y = mousePos.y;
    dots.forEach((dot, index) => {
        dot.style.left = x + "px";
        dot.style.top = y + "px";
        dot.style.opacity = 1 - (index / dots.length);
        dot.style.transform = `scale(${1 - (index / dots.length)})`;
        const next = dots[index + 1] || dots[0];
        x += (next.offsetLeft - x) * 0.4;
        y += (next.offsetTop - y) * 0.4;
    });
    requestAnimationFrame(updateTrail);
}
updateTrail();

/* 3. LUNA INTERACTIVA */
const moon = document.getElementById('moon-phase');
moon.addEventListener('click', () => {
    moon.classList.toggle('new-moon');
    document.body.style.background = moon.classList.contains('new-moon') ? "#050505" : "";
});

/* 4. REVELADO INICIAL Y AUDIO */
window.onload = () => {
    setTimeout(() => {
        document.getElementById('scratchAnimation').classList.add('hidden');
        document.getElementById('mainCard').style.opacity = "1";
        document.getElementById('mainCard').style.transform = "translateY(0)";
        document.querySelectorAll(".reveal").forEach(el => el.classList.add("visible"));
        document.querySelectorAll("#manifesto span").forEach((s, i) => {
            setTimeout(() => s.classList.add("visible"), 500 * i);
        });
    }, 1200);
};

// Activar audio ambiente al primer clic del usuario
document.addEventListener("click", () => {
    const ambient = document.getElementById("ambientSound");
    if (ambient.paused) { 
        ambient.volume = 0.4; 
        ambient.play(); 
    }
}, { once: true });

// Aullido al pasar el mouse por el título
document.getElementById('ahyronTitle').addEventListener('mouseenter', () => {
    const howl = document.getElementById("howlSound");
    howl.volume = 0.4;
    howl.play();
});

// Selector de Visión de Lobo
document.getElementById('wolfVisionToggle').addEventListener('click', () => {
    document.body.classList.toggle('wolf-vision');
});

/* 5. SISTEMA DE PARTÍCULAS (NIEVE/POLVO ESTELAR) */
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let parts = [];
for(let i=0; i<80; i++) {
    parts.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        s: Math.random() * 2
    });
}

function anim() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "rgba(127,255,212,0.3)";
    parts.forEach(p => {
        p.y -= 0.5; 
        if(p.y < 0) p.y = canvas.height;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.s, 0, Math.PI * 2);
        ctx.fill();
    });
    requestAnimationFrame(anim);
}
anim();

/* ─────────── NUEVAS MEJORAS DE INMERSIÓN ─────────── */

/* 6. EFECTO DE PROFUNDIDAD POR SCROLL */
window.addEventListener('scroll', () => {
    const scrolled = window.scrollY;
    const fog = document.querySelector('.fog');
    
    // La luna brilla más intensamente al bajar (basado en el scroll)
    const glowIntensity = 25 + (scrolled * 0.05);
    moon.style.boxShadow = `0 0 ${glowIntensity}px #fff`;
    
    // La niebla se vuelve sutilmente más densa al descender
    fog.style.opacity = 0.12 + (scrolled * 0.00005);
});

/* 7. PARALAJE EN VISIONES DEL LOBO (GALERÍA) */
document.querySelectorAll('.foto-lobo').forEach(item => {
    item.addEventListener('mousemove', (e) => {
        const img = item.querySelector('img');
        const rect = item.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const y = (e.clientY - rect.top) / rect.height;
        
        // Crea un efecto de enfoque dinámico basado en la posición del mouse
        img.style.transformOrigin = `${x * 100}% ${y * 100}%`;
    });
});

/* 8. ADRENALINA VISUAL (FEEDBACK EN TÍTULO) */
const titleElement = document.getElementById('ahyronTitle');
titleElement.addEventListener('mouseenter', () => {
    // Crea un resplandor perimetral cian al acechar el título
    document.body.style.boxShadow = "inset 0 0 150px rgba(127, 255, 212, 0.15)";
    document.body.style.transition = "box-shadow 0.5s ease";
});

titleElement.addEventListener('mouseleave', () => {
    document.body.style.boxShadow = "none";
});

/* 9. RE-AJUSTE DE CANVAS AL REDIMENSIONAR VENTANA */
window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});
